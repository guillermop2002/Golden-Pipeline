name: üõ°Ô∏è Security Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ============================================
  # üîç JOB 1: Detecci√≥n de Secretos con Gitleaks
  # ============================================
  gitleaks:
    name: üîë Gitleaks - Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para escanear todo el historial

      - name: üîç Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: true

  # ============================================
  # üî¨ JOB 2: An√°lisis SAST con Semgrep
  # ============================================
  semgrep:
    name: üî¨ Semgrep - SAST Analysis
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üî¨ Run Semgrep
        run: |
          echo "üöÄ Starting Semgrep SAST scan..."
          semgrep scan \
            --config auto \
            --config p/python \
            --config p/security-audit \
            --config p/secrets \
            --config p/owasp-top-ten \
            --error \
            --json --json-output=semgrep-results.json \
            .
        continue-on-error: false

      - name: üìä Upload Semgrep Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep-results.json

  # ============================================
  # üêç JOB 3: Verificaci√≥n de Dependencias
  # ============================================
  dependency-check:
    name: üì¶ Dependency Security Check
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: üîç Run Safety Check
        run: |
          echo "üîç Checking dependencies for known vulnerabilities..."
          safety check --full-report || true

      - name: üîç Run pip-audit
        run: |
          echo "üîç Running pip-audit..."
          pip-audit || true

  # ============================================
  # ‚úÖ JOB 4: Resumen de Seguridad
  # ============================================
  security-summary:
    name: üìã Security Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, semgrep, dependency-check]
    if: always()
    steps:
      - name: üìã Generate Summary
        run: |
          echo "# üõ°Ô∏è Security Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîë Gitleaks (Secrets) | ${{ needs.gitleaks.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üî¨ Semgrep (SAST) | ${{ needs.semgrep.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üì¶ Dependencies | ${{ needs.dependency-check.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üïê Scan completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Fail if security issues found
        if: needs.gitleaks.result != 'success' || needs.semgrep.result != 'success'
        run: |
          echo "‚ùå Security issues detected! Pipeline blocked."
          echo "Please review the security scan results and fix the vulnerabilities."
          exit 1
